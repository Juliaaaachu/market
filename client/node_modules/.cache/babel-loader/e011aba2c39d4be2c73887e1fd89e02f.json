{"ast":null,"code":"'use strict';\n\nconst symbols = require('../../schema/symbols');\n\nconst promiseOrCallback = require('../promiseOrCallback');\n/*!\n * ignore\n */\n\n\nmodule.exports = applyHooks;\n/*!\n * ignore\n */\n\napplyHooks.middlewareFunctions = ['deleteOne', 'save', 'validate', 'remove', 'updateOne', 'init'];\n/*!\n * Register hooks for this model\n *\n * @param {Model} model\n * @param {Schema} schema\n */\n\nfunction applyHooks(model, schema, options) {\n  options = options || {};\n  const kareemOptions = {\n    useErrorHandlers: true,\n    numCallbackParams: 1,\n    nullResultByDefault: true,\n    contextParameter: true\n  };\n  const objToDecorate = options.decorateDoc ? model : model.prototype;\n  model.$appliedHooks = true;\n\n  for (const key of Object.keys(schema.paths)) {\n    const type = schema.paths[key];\n    let childModel = null;\n\n    if (type.$isSingleNested) {\n      childModel = type.caster;\n    } else if (type.$isMongooseDocumentArray) {\n      childModel = type.Constructor;\n    } else {\n      continue;\n    }\n\n    if (childModel.$appliedHooks) {\n      continue;\n    }\n\n    applyHooks(childModel, type.schema, options);\n\n    if (childModel.discriminators != null) {\n      const keys = Object.keys(childModel.discriminators);\n\n      for (const key of keys) {\n        applyHooks(childModel.discriminators[key], childModel.discriminators[key].schema, options);\n      }\n    }\n  } // Built-in hooks rely on hooking internal functions in order to support\n  // promises and make it so that `doc.save.toString()` provides meaningful\n  // information.\n\n\n  const middleware = schema.s.hooks.filter(hook => {\n    if (hook.name === 'updateOne' || hook.name === 'deleteOne') {\n      return !!hook['document'];\n    }\n\n    if (hook.name === 'remove' || hook.name === 'init') {\n      return hook['document'] == null || !!hook['document'];\n    }\n\n    return true;\n  }).filter(hook => {\n    // If user has overwritten the method, don't apply built-in middleware\n    if (schema.methods[hook.name]) {\n      return !hook.fn[symbols.builtInMiddleware];\n    }\n\n    return true;\n  });\n  model._middleware = middleware;\n  objToDecorate.$__originalValidate = objToDecorate.$__originalValidate || objToDecorate.$__validate;\n\n  for (const method of ['save', 'validate', 'remove', 'deleteOne']) {\n    const toWrap = method === 'validate' ? '$__originalValidate' : `$__${method}`;\n    const wrapped = middleware.createWrapper(method, objToDecorate[toWrap], null, kareemOptions);\n    objToDecorate[`$__${method}`] = wrapped;\n  }\n\n  objToDecorate.$__init = middleware.createWrapperSync('init', objToDecorate.$__init, null, kareemOptions); // Support hooks for custom methods\n\n  const customMethods = Object.keys(schema.methods);\n  const customMethodOptions = Object.assign({}, kareemOptions, {\n    // Only use `checkForPromise` for custom methods, because mongoose\n    // query thunks are not as consistent as I would like about returning\n    // a nullish value rather than the query. If a query thunk returns\n    // a query, `checkForPromise` causes infinite recursion\n    checkForPromise: true\n  });\n\n  for (const method of customMethods) {\n    if (!middleware.hasHooks(method)) {\n      // Don't wrap if there are no hooks for the custom method to avoid\n      // surprises. Also, `createWrapper()` enforces consistent async,\n      // so wrapping a sync method would break it.\n      continue;\n    }\n\n    const originalMethod = objToDecorate[method];\n\n    objToDecorate[method] = function () {\n      const args = Array.prototype.slice.call(arguments);\n      const cb = args.slice(-1).pop();\n      const argsWithoutCallback = typeof cb === 'function' ? args.slice(0, args.length - 1) : args;\n      return promiseOrCallback(cb, callback => {\n        return this[`$__${method}`].apply(this, argsWithoutCallback.concat([callback]));\n      }, model.events);\n    };\n\n    objToDecorate[`$__${method}`] = middleware.createWrapper(method, originalMethod, null, customMethodOptions);\n  }\n}","map":{"version":3,"names":["symbols","require","promiseOrCallback","module","exports","applyHooks","middlewareFunctions","model","schema","options","kareemOptions","useErrorHandlers","numCallbackParams","nullResultByDefault","contextParameter","objToDecorate","decorateDoc","prototype","$appliedHooks","key","Object","keys","paths","type","childModel","$isSingleNested","caster","$isMongooseDocumentArray","Constructor","discriminators","middleware","s","hooks","filter","hook","name","methods","fn","builtInMiddleware","_middleware","$__originalValidate","$__validate","method","toWrap","wrapped","createWrapper","$__init","createWrapperSync","customMethods","customMethodOptions","assign","checkForPromise","hasHooks","originalMethod","args","Array","slice","call","arguments","cb","pop","argsWithoutCallback","length","callback","apply","concat","events"],"sources":["/Users/juliachu/Dropbox/CS/market/node_modules/mongoose/lib/helpers/model/applyHooks.js"],"sourcesContent":["'use strict';\n\nconst symbols = require('../../schema/symbols');\nconst promiseOrCallback = require('../promiseOrCallback');\n\n/*!\n * ignore\n */\n\nmodule.exports = applyHooks;\n\n/*!\n * ignore\n */\n\napplyHooks.middlewareFunctions = [\n  'deleteOne',\n  'save',\n  'validate',\n  'remove',\n  'updateOne',\n  'init'\n];\n\n/*!\n * Register hooks for this model\n *\n * @param {Model} model\n * @param {Schema} schema\n */\n\nfunction applyHooks(model, schema, options) {\n  options = options || {};\n\n  const kareemOptions = {\n    useErrorHandlers: true,\n    numCallbackParams: 1,\n    nullResultByDefault: true,\n    contextParameter: true\n  };\n  const objToDecorate = options.decorateDoc ? model : model.prototype;\n\n  model.$appliedHooks = true;\n  for (const key of Object.keys(schema.paths)) {\n    const type = schema.paths[key];\n    let childModel = null;\n    if (type.$isSingleNested) {\n      childModel = type.caster;\n    } else if (type.$isMongooseDocumentArray) {\n      childModel = type.Constructor;\n    } else {\n      continue;\n    }\n\n    if (childModel.$appliedHooks) {\n      continue;\n    }\n\n    applyHooks(childModel, type.schema, options);\n    if (childModel.discriminators != null) {\n      const keys = Object.keys(childModel.discriminators);\n      for (const key of keys) {\n        applyHooks(childModel.discriminators[key],\n          childModel.discriminators[key].schema, options);\n      }\n    }\n  }\n\n  // Built-in hooks rely on hooking internal functions in order to support\n  // promises and make it so that `doc.save.toString()` provides meaningful\n  // information.\n\n  const middleware = schema.s.hooks.\n    filter(hook => {\n      if (hook.name === 'updateOne' || hook.name === 'deleteOne') {\n        return !!hook['document'];\n      }\n      if (hook.name === 'remove' || hook.name === 'init') {\n        return hook['document'] == null || !!hook['document'];\n      }\n      return true;\n    }).\n    filter(hook => {\n      // If user has overwritten the method, don't apply built-in middleware\n      if (schema.methods[hook.name]) {\n        return !hook.fn[symbols.builtInMiddleware];\n      }\n\n      return true;\n    });\n\n  model._middleware = middleware;\n\n  objToDecorate.$__originalValidate = objToDecorate.$__originalValidate || objToDecorate.$__validate;\n\n  for (const method of ['save', 'validate', 'remove', 'deleteOne']) {\n    const toWrap = method === 'validate' ? '$__originalValidate' : `$__${method}`;\n    const wrapped = middleware.\n      createWrapper(method, objToDecorate[toWrap], null, kareemOptions);\n    objToDecorate[`$__${method}`] = wrapped;\n  }\n  objToDecorate.$__init = middleware.\n    createWrapperSync('init', objToDecorate.$__init, null, kareemOptions);\n\n  // Support hooks for custom methods\n  const customMethods = Object.keys(schema.methods);\n  const customMethodOptions = Object.assign({}, kareemOptions, {\n    // Only use `checkForPromise` for custom methods, because mongoose\n    // query thunks are not as consistent as I would like about returning\n    // a nullish value rather than the query. If a query thunk returns\n    // a query, `checkForPromise` causes infinite recursion\n    checkForPromise: true\n  });\n  for (const method of customMethods) {\n    if (!middleware.hasHooks(method)) {\n      // Don't wrap if there are no hooks for the custom method to avoid\n      // surprises. Also, `createWrapper()` enforces consistent async,\n      // so wrapping a sync method would break it.\n      continue;\n    }\n    const originalMethod = objToDecorate[method];\n    objToDecorate[method] = function() {\n      const args = Array.prototype.slice.call(arguments);\n      const cb = args.slice(-1).pop();\n      const argsWithoutCallback = typeof cb === 'function' ?\n        args.slice(0, args.length - 1) : args;\n      return promiseOrCallback(cb, callback => {\n        return this[`$__${method}`].apply(this,\n          argsWithoutCallback.concat([callback]));\n      }, model.events);\n    };\n    objToDecorate[`$__${method}`] = middleware.\n      createWrapper(method, originalMethod, null, customMethodOptions);\n  }\n}"],"mappings":"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"},"metadata":{},"sourceType":"script"}